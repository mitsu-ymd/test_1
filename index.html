<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt Studio - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”ŸæˆWebã‚¢ãƒ—ãƒª</title>
  <meta name="description" content="ãƒ†ãƒ³ãƒ—ãƒ¬ã¨å…¥åŠ›é …ç›®ã‹ã‚‰é«˜å“è³ªãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã€‚å±¥æ­´ãƒ»ã‚³ãƒ”ãƒ¼ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ç®¡ç†å¯¾å¿œã€‚" />
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1733;
      --panel2:#0c132a;
      --text:#e8ecff;
      --muted:#aeb7df;
      --line:rgba(255,255,255,.10);
      --brand:#7aa2ff;
      --brand2:#68e0ff;
      --good:#3ddc97;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Yu Gothic", Meiryo, Arial, "Noto Sans JP", sans-serif;
    }
    [data-theme="light"]{
      --bg:#f4f7ff;
      --panel:#ffffff;
      --panel2:#f7f9ff;
      --text:#0b1533;
      --muted:#4b5578;
      --line:rgba(0,0,0,.10);
      --brand:#3f6fff;
      --brand2:#08a1c7;
      --shadow: 0 18px 50px rgba(10,20,50,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(122,162,255,.30), transparent 60%),
        radial-gradient(900px 650px at 90% 20%, rgba(104,224,255,.18), transparent 60%),
        radial-gradient(900px 700px at 50% 110%, rgba(61,220,151,.14), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    a{color:inherit}

    .app{
      max-width:1200px;
      margin:0 auto;
      padding:18px 18px 30px;
      display:flex;
      flex-direction:column;
      gap:16px;
      min-height:100%;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:240px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 40%),
                  linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
    }
    .title{
      display:flex;flex-direction:column;line-height:1.2;
    }
    .title b{font-size:16px}
    .title span{font-size:12px;color:var(--muted)}
    .top-actions{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.02em;
      transition:.15s transform, .15s background, .15s border;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.10)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(122,162,255,.95), rgba(104,224,255,.85));
      color:#061026;
      border-color:transparent;
    }
    [data-theme="light"] .btn.primary{color:#061026}
    .btn.ghost{background:transparent}
    .btn.danger{background:rgba(255,107,107,.12); border-color:rgba(255,107,107,.35); color:var(--text)}
    .btn.good{background:rgba(61,220,151,.12); border-color:rgba(61,220,151,.35)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}
    .btn.icon{
      width:42px;height:42px;justify-content:center;
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
      flex:1;
      min-height:0;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      header{flex-wrap:wrap}
      .brand{min-width:auto}
      .top-actions{justify-content:flex-start}
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .card .head{
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .card .head h2{
      margin:0;
      font-size:13px;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .card .body{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .row.tight > *{flex:0}

    .field{
      display:flex;flex-direction:column;gap:6px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .hint{
      font-size:11px;
      color:var(--muted);
      opacity:.85;
    }
    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      transition:.15s border, .15s background;
      font-size:14px;
    }
    textarea{
      min-height:90px;
      resize:vertical;
      font-family:var(--sans);
      line-height:1.5;
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(122,162,255,.55);
      background:rgba(255,255,255,.06);
    }
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background:#f4f7ff;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.03);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:auto;
      padding-right:4px;
    }
    .item{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius2);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      cursor:pointer;
      transition:.15s transform,.15s background,.15s border;
    }
    .item:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
    .item.active{border-color:rgba(122,162,255,.55); background:rgba(122,162,255,.10)}
    .item .top{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .item b{font-size:14px}
    .item small{color:var(--muted); font-size:11px}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.03);
    }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      min-height:0;
    }

    .output{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
    }
    .output .bar{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(255,255,255,.03);
      flex-wrap:wrap;
    }
    .output .bar .left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .output .bar .left b{
      font-size:13px;
      letter-spacing:.05em;
      color:var(--muted);
      text-transform:uppercase;
    }
    .output pre{
      margin:0;
      padding:14px;
      overflow:auto;
      min-height:220px;
      max-height:520px;
      font-family:var(--mono);
      font-size:12.8px;
      line-height:1.55;
      white-space:pre-wrap;
      word-break:break-word;
      background:transparent;
      color:var(--text);
    }

    .toast{
      position:fixed;
      right:18px;
      bottom:18px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(20,30,60,.85);
      color:var(--text);
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
      transform: translateY(12px);
      opacity:0;
      pointer-events:none;
      transition:.18s opacity,.18s transform;
      max-width:min(560px, calc(100vw - 36px));
    }
    [data-theme="light"] .toast{background:rgba(255,255,255,.92)}
    .toast.show{opacity:1; transform:translateY(0)}
    .toast .t{font-weight:700; margin-right:10px}
    .toast .m{color:var(--muted)}

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:min(900px, 100%);
      max-height:min(92vh, 900px);
      overflow:auto;
      border-radius:20px;
      border:1px solid var(--line);
      background:var(--panel);
      box-shadow:var(--shadow);
    }
    .modal .mhead{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal .mhead b{font-size:14px}
    .modal .mbody{padding:14px; display:flex; flex-direction:column; gap:12px}

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .two{grid-template-columns:1fr}
    }

    .footer-note{
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding:0 4px;
    }

    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <div class="app" id="app" data-theme="dark">
    <header>
      <div class="brand" title="Prompt Studio">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Prompt Studio</b>
          <span>ãƒ†ãƒ³ãƒ—ãƒ¬Ã—å…¥åŠ›ã§ã€ã™ãä½¿ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ</span>
        </div>
      </div>

      <div class="top-actions">
        <button class="btn" id="btnTheme" type="button" title="ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯åˆ‡æ›¿ (T)">
          ğŸŒ— ãƒ†ãƒ¼ãƒ
        </button>
        <button class="btn" id="btnManage" type="button" title="ãƒ†ãƒ³ãƒ—ãƒ¬ç®¡ç† (M)">
          ğŸ§© ãƒ†ãƒ³ãƒ—ãƒ¬ç®¡ç†
        </button>
        <button class="btn" id="btnImportExport" type="button" title="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (I)">
          â¬†â¬‡ JSON
        </button>
        <button class="btn primary" id="btnGenerate" type="button" title="ç”Ÿæˆ (Ctrl/âŒ˜ + Enter)">
          âš¡ ç”Ÿæˆ
        </button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Templates + History -->
      <section class="card" aria-label="ãƒ†ãƒ³ãƒ—ãƒ¬ã¨å±¥æ­´">
        <div class="head">
          <h2>Templates</h2>
          <div class="row tight">
            <span class="pill" title="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: /ã§æ¤œç´¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹">
              ğŸ” <span class="kbd">/</span> æ¤œç´¢
            </span>
          </div>
        </div>

        <div class="body">
          <div class="field">
            <label for="searchTemplate">ãƒ†ãƒ³ãƒ—ãƒ¬æ¤œç´¢ <span class="hint">åå‰/ã‚¿ã‚°/æ¦‚è¦</span></label>
            <input id="searchTemplate" type="text" placeholder="ä¾‹: ãƒ–ãƒ­ã‚° / ä»•æ§˜ / ãƒ¡ãƒ¼ãƒ« / è¦ç´„ ..." autocomplete="off" />
          </div>

          <div class="row">
            <div class="field">
              <label for="filterCategory">ã‚«ãƒ†ã‚´ãƒª</label>
              <select id="filterCategory">
                <option value="all">ã™ã¹ã¦</option>
              </select>
            </div>
            <div class="field">
              <label for="filterLang">è¨€èª</label>
              <select id="filterLang">
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="en">English</option>
                <option value="any">æŒ‡å®šã—ãªã„</option>
              </select>
            </div>
          </div>

          <div class="list" id="templateList" aria-label="ãƒ†ãƒ³ãƒ—ãƒ¬ä¸€è¦§"></div>

          <div class="card" style="border-radius: var(--radius); background:rgba(255,255,255,.02); box-shadow:none;">
            <div class="head" style="border-radius: var(--radius) var(--radius) 0 0;">
              <h2>History</h2>
              <div class="row tight">
                <button class="btn small danger" id="btnClearHistory" type="button" title="å±¥æ­´ã‚’å‰Šé™¤">
                  ğŸ—‘ å±¥æ­´å‰Šé™¤
                </button>
              </div>
            </div>
            <div class="body" style="max-height:260px; overflow:auto;">
              <div class="list" id="historyList" aria-label="å±¥æ­´"></div>
              <div class="footer-note">
                <span>å±¥æ­´ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</span>
                <span class="mono muted" id="historyCount"></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Inputs + Output -->
      <main class="split" aria-label="å…¥åŠ›ã¨å‡ºåŠ›">
        <section class="card">
          <div class="head">
            <h2>Inputs</h2>
            <div class="row tight">
              <span class="pill" title="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: Ctrl/âŒ˜+Enterã§ç”Ÿæˆ">
                âŒ¨ <span class="kbd">Ctrl/âŒ˜</span> + <span class="kbd">Enter</span>
              </span>
            </div>
          </div>

          <div class="body">
            <div class="row">
              <div class="field">
                <label for="goal">ç›®çš„ <span class="hint">ä½•ã‚’é”æˆã—ãŸã„ã‹</span></label>
                <input id="goal" type="text" placeholder="ä¾‹: è¨˜äº‹æ§‹æˆã‚’ä½œã‚‹ / è¦ç‚¹ã‚’æŠ½å‡ºã™ã‚‹ / ä»•æ§˜æ›¸ã‚’èµ·ã“ã™ ..." />
              </div>
              <div class="field">
                <label for="audience">å¯¾è±¡ <span class="hint">èª°å‘ã‘ã®å‡ºåŠ›ã‹</span></label>
                <input id="audience" type="text" placeholder="ä¾‹: åˆå¿ƒè€… / ä¸Šå¸ / é¡§å®¢ / é–‹ç™ºè€… ..." />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="tone">ãƒˆãƒ¼ãƒ³</label>
                <select id="tone">
                  <option value="ä¸å¯§ã§æ˜å¿«">ä¸å¯§ã§æ˜å¿«</option>
                  <option value="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§è¦ªã—ã¿ã‚„ã™ã„">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§è¦ªã—ã¿ã‚„ã™ã„</option>
                  <option value="ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ç°¡æ½”">ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ç°¡æ½”</option>
                  <option value="è«–ç†çš„ã§å³å¯†">è«–ç†çš„ã§å³å¯†</option>
                  <option value="èª¬å¾—åŠ›é‡è¦–">èª¬å¾—åŠ›é‡è¦–</option>
                </select>
              </div>
              <div class="field">
                <label for="format">å‡ºåŠ›å½¢å¼</label>
                <select id="format">
                  <option value="ç®‡æ¡æ›¸ã">ç®‡æ¡æ›¸ã</option>
                  <option value="ã‚¹ãƒ†ãƒƒãƒ—å½¢å¼">ã‚¹ãƒ†ãƒƒãƒ—å½¢å¼</option>
                  <option value="è¡¨å½¢å¼">è¡¨å½¢å¼</option>
                  <option value="æ–‡ç« ">æ–‡ç« </option>
                  <option value="ã‚³ãƒ¼ãƒ‰">ã‚³ãƒ¼ãƒ‰</option>
                </select>
              </div>
              <div class="field">
                <label for="length">åˆ†é‡</label>
                <select id="length">
                  <option value="çŸ­ã‚">çŸ­ã‚</option>
                  <option value="æ¨™æº–" selected>æ¨™æº–</option>
                  <option value="é•·ã‚">é•·ã‚</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="context">èƒŒæ™¯/å‰æ <span class="hint">ææ–™ï¼ˆè¦ç‚¹ãƒ»åˆ¶ç´„ãƒ»çŠ¶æ³ï¼‰</span></label>
              <textarea id="context" placeholder="ä¾‹:
- å‰æ:
- å¿…è¦ãªè¦ç´ :
- ä½¿ã†ãƒ„ãƒ¼ãƒ«/ç’°å¢ƒ:
- NGäº‹é …:"></textarea>
            </div>

            <div class="row">
              <div class="field">
                <label for="constraints">åˆ¶ç´„ãƒ»ãƒ«ãƒ¼ãƒ« <span class="hint">å¿…ãšå®ˆã£ã¦ã»ã—ã„æ¡ä»¶</span></label>
                <textarea id="constraints" placeholder="ä¾‹:
- å°‚é–€ç”¨èªã¯å™›ã¿ç •ã
- æ•°å€¤ã¯æ ¹æ‹ ã‚’æ·»ãˆã‚‹
- ç®‡æ¡æ›¸ã + ä¾‹ã‚’å«ã‚ã‚‹"></textarea>
              </div>
              <div class="field">
                <label for="examples">å‚è€ƒä¾‹/å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ <span class="hint">æ–‡ç« /ãƒ­ã‚°/ãƒ‡ãƒ¼ã‚¿</span></label>
                <textarea id="examples" placeholder="ä¾‹:
ï¼ˆã“ã“ã«æ–‡ç« ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ï¼‰"></textarea>
              </div>
            </div>

            <div class="row">
              <button class="btn good" id="btnQuickFill" type="button" title="ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›ã‚’è‡ªå‹•ã§å…¥ã‚Œã‚‹">
                âœ¨ ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›
              </button>
              <button class="btn" id="btnResetInputs" type="button" title="å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢">
                ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢
              </button>
              <button class="btn" id="btnCopyOutput2" type="button" title="å‡ºåŠ›ã‚’ã‚³ãƒ”ãƒ¼">
                ğŸ“‹ å‡ºåŠ›ã‚³ãƒ”ãƒ¼
              </button>
            </div>

            <div class="footer-note">
              <span>ç¾åœ¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬: <b id="activeTemplateName">-</b></span>
              <span class="mono muted" id="autosaveState">autosave: on</span>
            </div>
          </div>
        </section>

        <section class="output" aria-label="ç”Ÿæˆçµæœ">
          <div class="bar">
            <div class="left">
              <b>Generated Prompt</b>
              <span class="pill" id="metaPill">â€”</span>
            </div>
            <div class="row tight" style="gap:8px;">
              <button class="btn small" id="btnCopyOutput" type="button" title="ã‚³ãƒ”ãƒ¼ (C)">
                ğŸ“‹ ã‚³ãƒ”ãƒ¼
              </button>
              <button class="btn small" id="btnDownload" type="button" title="TXTã¨ã—ã¦ä¿å­˜ (D)">
                â¬‡ TXT
              </button>
              <button class="btn small ghost" id="btnAddToHistory" type="button" title="å±¥æ­´ã«ä¿å­˜ (H)">
                â• å±¥æ­´
              </button>
            </div>
          </div>
          <pre id="output" class="mono" aria-label="å‡ºåŠ›" spellcheck="false"></pre>
        </section>
      </main>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <!-- MODAL: Manage Templates -->
    <div class="modal-backdrop" id="manageModalBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="ãƒ†ãƒ³ãƒ—ãƒ¬ç®¡ç†">
        <div class="mhead">
          <b>ğŸ§© ãƒ†ãƒ³ãƒ—ãƒ¬ç®¡ç†</b>
          <button class="btn icon" id="btnCloseManage" type="button" aria-label="é–‰ã˜ã‚‹">âœ•</button>
        </div>
        <div class="mbody">
          <div class="two">
            <div class="field">
              <label for="tplName">ãƒ†ãƒ³ãƒ—ãƒ¬å</label>
              <input id="tplName" type="text" placeholder="ä¾‹: ãƒ–ãƒ­ã‚°è¨˜äº‹æ§‹æˆ" />
            </div>
            <div class="field">
              <label for="tplCategory">ã‚«ãƒ†ã‚´ãƒª</label>
              <input id="tplCategory" type="text" placeholder="ä¾‹: Writing / Dev / Business" />
            </div>
          </div>

          <div class="two">
            <div class="field">
              <label for="tplLang">è¨€èª</label>
              <select id="tplLang">
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="en">English</option>
              </select>
            </div>
            <div class="field">
              <label for="tplTags">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
              <input id="tplTags" type="text" placeholder="ä¾‹: ãƒ–ãƒ­ã‚°,æ§‹æˆ,SEO" />
            </div>
          </div>

          <div class="field">
            <label for="tplDesc">æ¦‚è¦</label>
            <input id="tplDesc" type="text" placeholder="ä½•ã«ä½¿ã†ãƒ†ãƒ³ãƒ—ãƒ¬ã‹ã‚’çŸ­ã" />
          </div>

          <div class="field">
            <label for="tplBody">ãƒ†ãƒ³ãƒ—ãƒ¬æœ¬æ–‡ <span class="hint">{{goal}} {{audience}} {{tone}} {{format}} {{length}} {{context}} {{constraints}} {{examples}}</span></label>
            <textarea id="tplBody" style="min-height:210px" spellcheck="false"></textarea>
          </div>

          <div class="row">
            <button class="btn primary" id="btnSaveTemplate" type="button">ğŸ’¾ ä¿å­˜</button>
            <button class="btn" id="btnNewTemplate" type="button">â• æ–°è¦</button>
            <button class="btn danger" id="btnDeleteTemplate" type="button">ğŸ—‘ å‰Šé™¤</button>
          </div>

          <div class="footer-note">
            <span class="muted">â€»ãƒ†ãƒ³ãƒ—ãƒ¬ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚</span>
            <span class="muted">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: <span class="kbd">M</span> ã§é–‹é–‰</span>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Import/Export -->
    <div class="modal-backdrop" id="ieModalBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
        <div class="mhead">
          <b>â¬†â¬‡ JSON ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</b>
          <button class="btn icon" id="btnCloseIE" type="button" aria-label="é–‰ã˜ã‚‹">âœ•</button>
        </div>
        <div class="mbody">
          <div class="two">
            <div class="field">
              <label>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ <span class="hint">ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’JSONã§ã‚³ãƒ”ãƒ¼</span></label>
              <button class="btn good" id="btnExport" type="button">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
              <textarea id="exportArea" class="mono" style="min-height:220px" readonly></textarea>
              <div class="row tight">
                <button class="btn small" id="btnCopyExport" type="button">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                <button class="btn small" id="btnDownloadExport" type="button">â¬‡ JSONä¿å­˜</button>
              </div>
            </div>

            <div class="field">
              <label>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ <span class="hint">JSONã‚’è²¼ã£ã¦åæ˜ </span></label>
              <button class="btn" id="btnImport" type="button">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
              <textarea id="importArea" class="mono" style="min-height:220px" placeholder='{"templates":[ ... ]}'></textarea>
              <div class="row tight">
                <button class="btn small danger" id="btnOverwriteImport" type="button" title="ç¾åœ¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ç½®ãæ›ãˆã‚‹">
                  âš  ç½®æ›ã§åæ˜ 
                </button>
              </div>
              <div class="hint">é€šå¸¸ã®ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã¯æ—¢å­˜ãƒ†ãƒ³ãƒ—ãƒ¬ã«è¿½åŠ ã—ã¾ã™ã€‚ã€Œç½®æ›ã€ã¯å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚</div>
            </div>
          </div>

          <div class="footer-note">
            <span class="muted">â€»å–ã‚Šè¾¼ã‚ãªã„å ´åˆã¯JSONã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>
            <span class="muted">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: <span class="kbd">I</span> ã§é–‹é–‰</span>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  "use strict";

  // ---------- Utilities ----------
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const nowIso = () => new Date().toISOString();
  const fmtTime = (iso) => {
    try{
      const d = new Date(iso);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }catch{ return iso; }
  };
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

  const toastEl = $("#toast");
  let toastTimer = null;
  const toast = (title, msg="", ms=2200) => {
    toastEl.innerHTML = `<span class="t">${escapeHtml(title)}</span><span class="m">${escapeHtml(msg)}</span>`;
    toastEl.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toastEl.classList.remove("show"), ms);
  };

  const escapeHtml = (s) => String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");

  const downloadText = (filename, content, mime="text/plain;charset=utf-8") => {
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  const copyToClipboard = async (text) => {
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch{
      // fallback
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return ok;
      }catch{
        return false;
      }
    }
  };

  // ---------- Storage ----------
  const KEY = {
    templates: "prompt_studio_templates_v1",
    history: "prompt_studio_history_v1",
    ui: "prompt_studio_ui_v1",
    inputs: "prompt_studio_inputs_v1"
  };

  const readJson = (k, fallback) => {
    try{
      const raw = localStorage.getItem(k);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch{ return fallback; }
  };
  const writeJson = (k, v) => {
    localStorage.setItem(k, JSON.stringify(v));
  };

  // ---------- Default Templates ----------
  const DEFAULT_TEMPLATES = [
    {
      id: "tpl_blog_outline_ja",
      name: "ãƒ–ãƒ­ã‚°è¨˜äº‹ã®æ§‹æˆï¼ˆæ—¥æœ¬èªï¼‰",
      category: "Writing",
      lang: "ja",
      tags: ["ãƒ–ãƒ­ã‚°","æ§‹æˆ","SEO"],
      desc: "è¨˜äº‹ã®éª¨å­â†’è¦‹å‡ºã—æ¡ˆâ†’åŸ·ç­†æ–¹é‡ã¾ã§ä½œã‚‹",
      body:
`ã‚ãªãŸã¯å„ªç§€ãªç·¨é›†è€…ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§ãƒ–ãƒ­ã‚°è¨˜äº‹ã®æ§‹æˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ç›®çš„ã€‘
{{goal}}

ã€å¯¾è±¡èª­è€…ã€‘
{{audience}}

ã€ãƒˆãƒ¼ãƒ³ã€‘
{{tone}}

ã€å‡ºåŠ›å½¢å¼ã€‘
{{format}}ï¼ˆè¦‹å‡ºã—ã¯H2/H3ã§ï¼‰

ã€åˆ†é‡ã€‘
{{length}}

ã€èƒŒæ™¯/å‰æã€‘
{{context}}

ã€åˆ¶ç´„ãƒ»ãƒ«ãƒ¼ãƒ«ã€‘
{{constraints}}

ã€å‚è€ƒä¾‹/å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã€‘
{{examples}}

ã€å¿…é ˆè¦ä»¶ã€‘
1) ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆã‚’5ã¤
2) è¦‹å‡ºã—æ§‹æˆï¼ˆH2/H3ï¼‰ã‚’æç¤º
3) å„è¦‹å‡ºã—ã®è¦ç‚¹ï¼ˆç®‡æ¡æ›¸ãï¼‰
4) å…·ä½“ä¾‹/ãŸã¨ãˆè©±ã‚’æœ€ä½2ã¤å«ã‚ã‚‹
5) SEOè¦³ç‚¹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å€™è£œï¼ˆ5ã€œ10å€‹ï¼‰
6) æœ€å¾Œã«ã€Œèª­è€…ãŒæ¬¡ã«å–ã‚‹è¡Œå‹•ã€ã®ææ¡ˆã‚’3ã¤`
    },
    {
      id: "tpl_spec_ja",
      name: "è¦ä»¶â†’ä»•æ§˜æ•´ç†ï¼ˆæ—¥æœ¬èªï¼‰",
      category: "Dev",
      lang: "ja",
      tags: ["ä»•æ§˜","è¦ä»¶å®šç¾©","æ•´ç†"],
      desc: "æ›–æ˜§ãªè¦æœ›ã‚’ä»•æ§˜ã«è½ã¨ã—è¾¼ã‚€è³ªå•ãƒ»å‰æãƒ»æ±ºå®šäº‹é …ã‚’æ•´ç†",
      body:
`ã‚ãªãŸã¯ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å…¼ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‹ã‚‰ä»•æ§˜ã‚’æ•´ç†ã—ã¦ãã ã•ã„ã€‚

ã€ç›®çš„ã€‘
{{goal}}

ã€å¯¾è±¡ï¼ˆé–¢ä¿‚è€…ï¼‰ã€‘
{{audience}}

ã€ãƒˆãƒ¼ãƒ³ã€‘
{{tone}}

ã€å‡ºåŠ›å½¢å¼ã€‘
è¡¨å½¢å¼ï¼ˆé …ç›® / å†…å®¹ï¼‰â†’ ãã®å¾Œã«ç®‡æ¡æ›¸ãã§è©³ç´°

ã€èƒŒæ™¯/å‰æã€‘
{{context}}

ã€åˆ¶ç´„ãƒ»ãƒ«ãƒ¼ãƒ«ã€‘
{{constraints}}

ã€å‚è€ƒä¾‹/å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã€‘
{{examples}}

ã€å‡ºåŠ›ã—ã¦ã»ã—ã„é …ç›®ã€‘
- ç›®çš„ãƒ»æˆåŠŸæŒ‡æ¨™ï¼ˆKPIï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼èª²é¡Œ / ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
- æ©Ÿèƒ½è¦ä»¶ / éæ©Ÿèƒ½è¦ä»¶
- ç”»é¢/å…¥å‡ºåŠ›ï¼ˆã‚ã‚Œã°ï¼‰
- ä¾‹å¤–ã‚±ãƒ¼ã‚¹ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»æ¨©é™
- æœªç¢ºå®šäº‹é …ï¼ˆè³ªå•ãƒªã‚¹ãƒˆï¼‰
- å„ªå…ˆåº¦ï¼ˆMust/Should/Could/Won'tï¼‰
- å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆãƒ†ã‚¹ãƒˆè¦³ç‚¹ï¼‰`
    },
    {
      id: "tpl_summarize_ja",
      name: "é•·æ–‡è¦ç´„ï¼ˆæ—¥æœ¬èªï¼‰",
      category: "Business",
      lang: "ja",
      tags: ["è¦ç´„","è­°äº‹éŒ²","æ•´ç†"],
      desc: "é‡è¦ç‚¹ãƒ»çµè«–ãƒ»ToDoã«åˆ†ã‘ã¦è¦ç´„",
      body:
`ã‚ãªãŸã¯è¦ç´„ã®å°‚é–€å®¶ã§ã™ã€‚æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€èª­ã¿æ‰‹ãŒã™ãæ„æ€æ±ºå®šã§ãã‚‹å½¢ã«æ•´ç†ã—ã¦ãã ã•ã„ã€‚

ã€ç›®çš„ã€‘
{{goal}}

ã€å¯¾è±¡èª­è€…ã€‘
{{audience}}

ã€ãƒˆãƒ¼ãƒ³ã€‘
{{tone}}

ã€å‡ºåŠ›å½¢å¼ã€‘
1) 3è¡Œè¦ç´„
2) é‡è¦ç‚¹ï¼ˆç®‡æ¡æ›¸ãï¼‰
3) äº‰ç‚¹/ãƒªã‚¹ã‚¯
4) æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆToDoï¼šæ‹…å½“/æœŸé™ã®ææ¡ˆã‚‚ï¼‰
5) ç”¨èªã®ç°¡å˜ãªèª¬æ˜ï¼ˆå¿…è¦ãªã‚‰ï¼‰

ã€åˆ†é‡ã€‘
{{length}}

ã€åˆ¶ç´„ãƒ»ãƒ«ãƒ¼ãƒ«ã€‘
{{constraints}}

ã€å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã€‘
{{examples}}`
    },
    {
      id: "tpl_email_en",
      name: "Professional Email (English)",
      category: "Business",
      lang: "en",
      tags: ["email","business","polite"],
      desc: "Clear subject + concise email with next steps",
      body:
`You are an excellent business communicator. Write a professional email.

Goal:
{{goal}}

Audience / Recipient:
{{audience}}

Tone:
{{tone}}

Format:
- Subject line
- Greeting
- 2â€“5 short paragraphs
- Bullet list for requests (if any)
- Clear next steps + deadline suggestion
- Polite closing

Context:
{{context}}

Constraints:
{{constraints}}

Reference / Data:
{{examples}}`
    },
    {
      id: "tpl_code_review_ja",
      name: "ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ï¼ˆæ—¥æœ¬èªï¼‰",
      category: "Dev",
      lang: "ja",
      tags: ["ãƒ¬ãƒ“ãƒ¥ãƒ¼","ã‚³ãƒ¼ãƒ‰","æ”¹å–„"],
      desc: "ãƒã‚°/æ”¹å–„/å¯èª­æ€§/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ",
      body:
`ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

ã€ç›®çš„ã€‘
{{goal}}

ã€å¯¾è±¡èª­è€…ã€‘
{{audience}}

ã€ãƒˆãƒ¼ãƒ³ã€‘
{{tone}}

ã€å‡ºåŠ›å½¢å¼ã€‘
- æŒ‡æ‘˜ä¸€è¦§ï¼ˆé‡å¤§åº¦: High/Medium/Lowï¼‰
- æ”¹å–„æ¡ˆï¼ˆå…·ä½“çš„ãªä¿®æ­£ä¾‹ï¼‰
- ãƒªã‚¹ã‚¯ï¼ˆæ€§èƒ½/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/ä¿å®ˆæ€§ï¼‰
- è¿½åŠ ã§ç¢ºèªã—ãŸã„ç‚¹ï¼ˆè³ªå•ï¼‰

ã€åˆ¶ç´„ãƒ»ãƒ«ãƒ¼ãƒ«ã€‘
{{constraints}}

ã€ã‚³ãƒ¼ãƒ‰/æƒ…å ±ã€‘
{{examples}}`
    }
  ];

  // ---------- State ----------
  let state = {
    templates: [],
    activeTemplateId: "",
    history: [],
    ui: { theme: "dark", filterCategory:"all", filterLang:"ja", search:"" },
    inputs: {
      goal:"",
      audience:"",
      tone:"ä¸å¯§ã§æ˜å¿«",
      format:"ç®‡æ¡æ›¸ã",
      length:"æ¨™æº–",
      context:"",
      constraints:"",
      examples:""
    },
    output: ""
  };

  const loadState = () => {
    const templates = readJson(KEY.templates, null);
    const history = readJson(KEY.history, []);
    const ui = readJson(KEY.ui, null);
    const inputs = readJson(KEY.inputs, null);

    state.templates = Array.isArray(templates) && templates.length ? templates : DEFAULT_TEMPLATES;
    state.history = Array.isArray(history) ? history : [];
    state.ui = ui ? {...state.ui, ...ui} : state.ui;
    state.inputs = inputs ? {...state.inputs, ...inputs} : state.inputs;

    if(!state.activeTemplateId){
      state.activeTemplateId = state.templates[0]?.id || "";
    }

    // If previously selected template exists, keep it; otherwise set to first
    const savedActive = (ui && ui.activeTemplateId) ? ui.activeTemplateId : "";
    if(savedActive && state.templates.some(t=>t.id===savedActive)){
      state.activeTemplateId = savedActive;
    }
  };

  const saveTemplates = () => writeJson(KEY.templates, state.templates);
  const saveHistory = () => writeJson(KEY.history, state.history);
  const saveUI = () => writeJson(KEY.ui, {...state.ui, activeTemplateId: state.activeTemplateId});
  const saveInputs = () => writeJson(KEY.inputs, state.inputs);

  // ---------- Rendering ----------
  const appEl = $("#app");
  const templateListEl = $("#templateList");
  const historyListEl = $("#historyList");
  const historyCountEl = $("#historyCount");
  const activeTemplateNameEl = $("#activeTemplateName");
  const outputEl = $("#output");
  const metaPillEl = $("#metaPill");

  const rebuildCategoryOptions = () => {
    const sel = $("#filterCategory");
    const cats = [...new Set(state.templates.map(t=>t.category || "Other"))].sort((a,b)=>a.localeCompare(b));
    const current = state.ui.filterCategory || "all";
    sel.innerHTML = `<option value="all">ã™ã¹ã¦</option>` + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    sel.value = cats.includes(current) ? current : "all";
  };

  const renderTemplates = () => {
    const q = (state.ui.search || "").trim().toLowerCase();
    const cat = state.ui.filterCategory || "all";
    const langFilter = state.ui.filterLang || "ja";

    const filtered = state.templates.filter(t => {
      const inCat = (cat==="all") ? true : (t.category===cat);
      const inLang = (langFilter==="any") ? true : (t.lang===langFilter);
      if(!inCat || !inLang) return false;
      if(!q) return true;
      const hay = [
        t.name, t.desc, t.category, (t.tags||[]).join(",")
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });

    templateListEl.innerHTML = filtered.map(t => {
      const isActive = t.id === state.activeTemplateId;
      const tags = (t.tags||[]).slice(0,6).map(x => `<span class="tag">${escapeHtml(x)}</span>`).join("");
      return `
        <div class="item ${isActive ? "active" : ""}" data-id="${escapeHtml(t.id)}" role="button" tabindex="0" aria-label="${escapeHtml(t.name)}">
          <div class="top">
            <div style="display:flex;flex-direction:column;gap:3px">
              <b>${escapeHtml(t.name)}</b>
              <small>${escapeHtml(t.desc || "")}</small>
            </div>
            <small class="tag" title="ã‚«ãƒ†ã‚´ãƒª">${escapeHtml(t.category || "Other")}</small>
          </div>
          <div class="tags">
            <span class="tag" title="è¨€èª">${t.lang === "en" ? "EN" : "JA"}</span>
            ${tags}
          </div>
        </div>
      `;
    }).join("");

    if(filtered.length === 0){
      templateListEl.innerHTML = `
        <div class="item" style="cursor:default;">
          <b>ä¸€è‡´ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Šã¾ã›ã‚“</b>
          <small>æ¤œç´¢èªã‚’å¤‰ãˆã‚‹ã‹ã€ãƒ†ãƒ³ãƒ—ãƒ¬ç®¡ç†ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</small>
        </div>
      `;
    }

    // Update active template label
    const active = state.templates.find(t=>t.id===state.activeTemplateId);
    activeTemplateNameEl.textContent = active ? active.name : "-";

    // Populate category options (kept in sync)
    rebuildCategoryOptions();
  };

  const renderHistory = () => {
    const items = state.history.slice().sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||"")).slice(0, 30);
    historyListEl.innerHTML = items.map(h => {
      const tname = h.templateName || "â€”";
      const dt = fmtTime(h.createdAt);
      const preview = (h.output||"").slice(0, 140).replace(/\s+/g," ").trim();
      return `
        <div class="item" data-hid="${escapeHtml(h.id)}" role="button" tabindex="0" aria-label="å±¥æ­´: ${escapeHtml(tname)}">
          <div class="top">
            <div style="display:flex;flex-direction:column;gap:3px">
              <b>${escapeHtml(tname)}</b>
              <small>${escapeHtml(dt)}</small>
            </div>
            <small class="tag" title="ãƒ†ãƒ³ãƒ—ãƒ¬">${escapeHtml(h.templateCategory || "â€”")}</small>
          </div>
          <small class="muted">${escapeHtml(preview)}${h.output && h.output.length>140 ? "â€¦" : ""}</small>
        </div>
      `;
    }).join("");

    const total = state.history.length;
    historyCountEl.textContent = `items: ${total}`;

    if(items.length === 0){
      historyListEl.innerHTML = `
        <div class="item" style="cursor:default;">
          <b>å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</b>
          <small>ç”Ÿæˆã—ãŸå†…å®¹ã‚’ã€Œâ• å±¥æ­´ã€ã§ä¿å­˜ã§ãã¾ã™ã€‚</small>
        </div>
      `;
    }
  };

  const renderOutput = () => {
    outputEl.textContent = state.output || "";
    const tpl = state.templates.find(t=>t.id===state.activeTemplateId);
    const meta = tpl
      ? `${tpl.category || "Other"} / ${tpl.lang === "en" ? "EN" : "JA"}`
      : "â€”";
    metaPillEl.textContent = meta;
  };

  const applyTheme = () => {
    appEl.setAttribute("data-theme", state.ui.theme || "dark");
  };

  // ---------- Prompt Generation ----------
  const fillVars = (templateBody, vars) => {
    let out = String(templateBody || "");
    const map = {
      goal: vars.goal || "",
      audience: vars.audience || "",
      tone: vars.tone || "",
      format: vars.format || "",
      length: vars.length || "",
      context: vars.context || "",
      constraints: vars.constraints || "",
      examples: vars.examples || ""
    };
    // Replace {{key}} with value
    for(const [k,v] of Object.entries(map)){
      const re = new RegExp("\\{\\{\\s*" + k + "\\s*\\}\\}", "g");
      out = out.replace(re, v.trim());
    }
    // Cleanup repeated blank lines
    out = out.replace(/\n{3,}/g, "\n\n").trim();
    return out;
  };

  const generate = () => {
    const tpl = state.templates.find(t=>t.id===state.activeTemplateId);
    if(!tpl){
      toast("ãƒ†ãƒ³ãƒ—ãƒ¬ãŒæœªé¸æŠã§ã™", "å·¦ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
      return;
    }

    const vars = {...state.inputs};
    // Basic defaults to prevent empty
    if(!vars.goal.trim()) vars.goal = "ï¼ˆç›®çš„ã‚’ã“ã“ã«è¨˜å…¥ï¼‰";
    if(!vars.audience.trim()) vars.audience = "ï¼ˆå¯¾è±¡ã‚’ã“ã“ã«è¨˜å…¥ï¼‰";

    const out = fillVars(tpl.body, vars);
    state.output = out;
    renderOutput();
    toast("ç”Ÿæˆã—ã¾ã—ãŸ", "ã‚³ãƒ”ãƒ¼ã‚„å±¥æ­´ä¿å­˜ãŒã§ãã¾ã™ã€‚");
  };

  // ---------- Inputs Binding ----------
  const bindInputs = () => {
    const inputMap = [
      ["#goal","goal"],
      ["#audience","audience"],
      ["#tone","tone"],
      ["#format","format"],
      ["#length","length"],
      ["#context","context"],
      ["#constraints","constraints"],
      ["#examples","examples"]
    ];

    for(const [sel, key] of inputMap){
      const el = $(sel);
      el.value = state.inputs[key] ?? "";
      el.addEventListener("input", () => {
        state.inputs[key] = el.value;
        saveInputs();
      });
      el.addEventListener("change", () => {
        state.inputs[key] = el.value;
        saveInputs();
      });
    }
  };

  const resetInputs = () => {
    state.inputs = {
      goal:"",
      audience:"",
      tone: $("#tone").value || "ä¸å¯§ã§æ˜å¿«",
      format: $("#format").value || "ç®‡æ¡æ›¸ã",
      length: $("#length").value || "æ¨™æº–",
      context:"",
      constraints:"",
      examples:""
    };
    bindInputs();
    saveInputs();
    toast("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
  };

  const quickFill = () => {
    state.inputs.goal = "ç¤¾å†…å‘ã‘ã«æ–°ã—ã„æ‰‹é †ã‚’ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ãŸã„";
    state.inputs.audience = "åˆã‚ã¦ä½œæ¥­ã™ã‚‹æ‹…å½“è€…ï¼ˆITãŒå¾—æ„ã§ã¯ãªã„äººã‚‚å«ã‚€ï¼‰";
    state.inputs.tone = "ä¸å¯§ã§æ˜å¿«";
    state.inputs.format = "ã‚¹ãƒ†ãƒƒãƒ—å½¢å¼";
    state.inputs.length = "æ¨™æº–";
    state.inputs.context =
`- ç¾å ´ã§ã¯æ™‚é–“ãŒãªã„ãŸã‚ã€è¿·ã„ã©ã“ã‚ã‚’å…ˆå›ã‚Šã—ã¦èª¬æ˜ã—ãŸã„
- ä¾‹å¤–ã‚±ãƒ¼ã‚¹ãŒãŸã¾ã«ç™ºç”Ÿã™ã‚‹
- å¿…è¦ãªæº–å‚™ç‰©ã‚„æ³¨æ„äº‹é …ã‚’æœ€åˆã«ã¾ã¨ã‚ãŸã„`;
    state.inputs.constraints =
`- å°‚é–€ç”¨èªã¯å¿…ãšä¸€è¨€ã§è£œè¶³ã™ã‚‹
- æ‰‹é †ã¯ç•ªå·ä»˜ãã§ã€å„æ‰‹é †ã«ã€Œç›®çš„ã€ã‚’æ·»ãˆã‚‹
- ã‚ˆãã‚ã‚‹ãƒŸã‚¹ã¨å¯¾å‡¦ã‚’æœ€å¾Œã«ã¾ã¨ã‚ã‚‹`;
    state.inputs.examples =
`ï¼ˆå¯¾è±¡ã®ä½œæ¥­å†…å®¹ã‚„æ‰‹é †ãƒ¡ãƒ¢ã€ãƒ­ã‚°ã€æ–‡ç« ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ï¼‰`;

    bindInputs();
    saveInputs();
    toast("ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›ã‚’å…¥ã‚Œã¾ã—ãŸ");
  };

  // ---------- Template selection ----------
  const setActiveTemplate = (id) => {
    if(!state.templates.some(t=>t.id===id)) return;
    state.activeTemplateId = id;
    saveUI();
    renderTemplates();
    // Auto-generate to reflect template change (optional)
    if(state.output && state.output.trim()){
      generate();
    }
  };

  const wireTemplateClicks = () => {
    templateListEl.addEventListener("click", (e) => {
      const item = e.target.closest(".item");
      if(!item) return;
      const id = item.getAttribute("data-id");
      if(id) setActiveTemplate(id);
    });
    templateListEl.addEventListener("keydown", (e) => {
      if(e.key !== "Enter" && e.key !== " ") return;
      const item = e.target.closest(".item");
      if(!item) return;
      const id = item.getAttribute("data-id");
      if(id){
        e.preventDefault();
        setActiveTemplate(id);
      }
    });
  };

  // ---------- History ----------
  const addToHistory = () => {
    const tpl = state.templates.find(t=>t.id===state.activeTemplateId);
    if(!tpl){
      toast("ãƒ†ãƒ³ãƒ—ãƒ¬ãŒæœªé¸æŠã§ã™");
      return;
    }
    if(!state.output.trim()){
      toast("å‡ºåŠ›ãŒç©ºã§ã™", "å…ˆã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    const item = {
      id: uid(),
      createdAt: nowIso(),
      templateId: tpl.id,
      templateName: tpl.name,
      templateCategory: tpl.category,
      inputs: {...state.inputs},
      output: state.output
    };
    state.history.push(item);
    // Keep last 200
    if(state.history.length > 200){
      state.history = state.history.slice(state.history.length - 200);
    }
    saveHistory();
    renderHistory();
    toast("å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ", fmtTime(item.createdAt));
  };

  const clearHistory = () => {
    state.history = [];
    saveHistory();
    renderHistory();
    toast("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  };

  const loadFromHistory = (hid) => {
    const h = state.history.find(x=>x.id===hid);
    if(!h) return;
    // Restore inputs + output
    state.inputs = {...state.inputs, ...(h.inputs || {})};
    state.output = h.output || "";
    // Restore template if exists
    if(h.templateId && state.templates.some(t=>t.id===h.templateId)){
      state.activeTemplateId = h.templateId;
      saveUI();
    }
    bindInputs();
    renderTemplates();
    renderOutput();
    toast("å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ", h.templateName || "");
  };

  const wireHistoryClicks = () => {
    historyListEl.addEventListener("click", (e) => {
      const item = e.target.closest(".item");
      if(!item) return;
      const hid = item.getAttribute("data-hid");
      if(hid) loadFromHistory(hid);
    });
    historyListEl.addEventListener("keydown", (e) => {
      if(e.key !== "Enter" && e.key !== " ") return;
      const item = e.target.closest(".item");
      if(!item) return;
      const hid = item.getAttribute("data-hid");
      if(hid){
        e.preventDefault();
        loadFromHistory(hid);
      }
    });
  };

  // ---------- Manage Templates Modal ----------
  const manageBackdrop = $("#manageModalBackdrop");
  const openManage = () => {
    manageBackdrop.classList.add("show");
    manageBackdrop.setAttribute("aria-hidden","false");
    // Fill with active template
    const tpl = state.templates.find(t=>t.id===state.activeTemplateId) || state.templates[0];
    if(tpl) fillManageForm(tpl);
  };
  const closeManage = () => {
    manageBackdrop.classList.remove("show");
    manageBackdrop.setAttribute("aria-hidden","true");
  };

  const fillManageForm = (tpl) => {
    $("#tplName").value = tpl.name || "";
    $("#tplCategory").value = tpl.category || "";
    $("#tplLang").value = tpl.lang || "ja";
    $("#tplTags").value = (tpl.tags || []).join(", ");
    $("#tplDesc").value = tpl.desc || "";
    $("#tplBody").value = tpl.body || "";
    $("#btnDeleteTemplate").disabled = tpl.id && String(tpl.id).startsWith("tpl_") ? false : false;
  };

  const makeTemplateFromForm = (existingId=null) => {
    const name = $("#tplName").value.trim() || "Untitled Template";
    const category = $("#tplCategory").value.trim() || "Other";
    const lang = $("#tplLang").value || "ja";
    const tags = $("#tplTags").value.split(",").map(s=>s.trim()).filter(Boolean);
    const desc = $("#tplDesc").value.trim();
    const body = $("#tplBody").value;

    return {
      id: existingId || uid(),
      name, category, lang, tags, desc, body
    };
  };

  const saveTemplateFromModal = () => {
    const currentId = state.activeTemplateId;
    const idx = state.templates.findIndex(t=>t.id===currentId);
    if(idx === -1){
      const tpl = makeTemplateFromForm(null);
      state.templates.unshift(tpl);
      state.activeTemplateId = tpl.id;
    }else{
      const updated = makeTemplateFromForm(currentId);
      state.templates[idx] = updated;
    }
    saveTemplates();
    saveUI();
    renderTemplates();
    toast("ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  };

  const newTemplate = () => {
    const tpl = {
      id: uid(),
      name: "æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬",
      category: "Other",
      lang: "ja",
      tags: [],
      desc: "ã“ã“ã«æ¦‚è¦",
      body:
`ã‚ãªãŸã¯å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§æœ€é©ãªå‡ºåŠ›ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ç›®çš„ã€‘
{{goal}}

ã€å¯¾è±¡ã€‘
{{audience}}

ã€ãƒˆãƒ¼ãƒ³ã€‘
{{tone}}

ã€å‡ºåŠ›å½¢å¼ã€‘
{{format}}

ã€åˆ†é‡ã€‘
{{length}}

ã€èƒŒæ™¯/å‰æã€‘
{{context}}

ã€åˆ¶ç´„ãƒ»ãƒ«ãƒ¼ãƒ«ã€‘
{{constraints}}

ã€å‚è€ƒä¾‹/å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã€‘
{{examples}}`
    };
    state.templates.unshift(tpl);
    state.activeTemplateId = tpl.id;
    saveTemplates();
    saveUI();
    renderTemplates();
    fillManageForm(tpl);
    toast("æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ä½œæˆã—ã¾ã—ãŸ");
  };

  const deleteActiveTemplate = () => {
    const id = state.activeTemplateId;
    if(state.templates.length <= 1){
      toast("å‰Šé™¤ã§ãã¾ã›ã‚“", "ãƒ†ãƒ³ãƒ—ãƒ¬ã¯æœ€ä½1ã¤å¿…è¦ã§ã™ã€‚");
      return;
    }
    const idx = state.templates.findIndex(t=>t.id===id);
    if(idx === -1) return;

    const name = state.templates[idx].name;
    const ok = confirm(`ãƒ†ãƒ³ãƒ—ãƒ¬ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
    if(!ok) return;

    state.templates.splice(idx,1);
    state.activeTemplateId = state.templates[0].id;
    saveTemplates();
    saveUI();
    renderTemplates();
    toast("å‰Šé™¤ã—ã¾ã—ãŸ", name);
  };

  // ---------- Import/Export Modal ----------
  const ieBackdrop = $("#ieModalBackdrop");
  const openIE = () => {
    ieBackdrop.classList.add("show");
    ieBackdrop.setAttribute("aria-hidden","false");
    $("#exportArea").value = "";
  };
  const closeIE = () => {
    ieBackdrop.classList.remove("show");
    ieBackdrop.setAttribute("aria-hidden","true");
  };

  const exportTemplates = () => {
    const payload = {
      app: "Prompt Studio",
      version: 1,
      exportedAt: nowIso(),
      templates: state.templates
    };
    const text = JSON.stringify(payload, null, 2);
    $("#exportArea").value = text;
    toast("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ", "ä¸‹ã®æ¬„ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚");
  };

  const importTemplates = (overwrite=false) => {
    const raw = $("#importArea").value.trim();
    if(!raw){
      toast("ç©ºã§ã™", "JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
      return;
    }
    try{
      const obj = JSON.parse(raw);
      const incoming = obj.templates || obj;
      if(!Array.isArray(incoming)){
        toast("å½¢å¼ã‚¨ãƒ©ãƒ¼", "templatesé…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      // Sanitize: required fields
      const cleaned = incoming.map(t => ({
        id: t.id || uid(),
        name: t.name || "Untitled Template",
        category: t.category || "Other",
        lang: (t.lang === "en") ? "en" : "ja",
        tags: Array.isArray(t.tags) ? t.tags.filter(Boolean) : [],
        desc: t.desc || "",
        body: t.body || ""
      }));

      if(overwrite){
        state.templates = cleaned.length ? cleaned : state.templates;
      }else{
        // merge by id (if conflict, rename)
        const existingIds = new Set(state.templates.map(t=>t.id));
        const merged = [...state.templates];
        for(const t of cleaned){
          if(existingIds.has(t.id)){
            // make a new id to avoid overwrite
            t.id = uid();
            t.name = t.name + " (Imported)";
          }
          merged.push(t);
        }
        state.templates = merged;
      }

      if(!state.templates.some(t=>t.id===state.activeTemplateId)){
        state.activeTemplateId = state.templates[0]?.id || "";
      }

      saveTemplates();
      saveUI();
      renderTemplates();
      toast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ", overwrite ? "ç½®æ›ã§åæ˜ " : "è¿½åŠ ã§åæ˜ ");
    }catch(err){
      toast("JSONè§£æã«å¤±æ•—", String(err && err.message ? err.message : err));
    }
  };

  // ---------- Buttons ----------
  const wireButtons = () => {
    $("#btnGenerate").addEventListener("click", generate);

    $("#btnCopyOutput").addEventListener("click", async () => {
      if(!state.output.trim()){
        toast("å‡ºåŠ›ãŒç©ºã§ã™", "å…ˆã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const ok = await copyToClipboard(state.output);
      toast(ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ" : "ã‚³ãƒ”ãƒ¼å¤±æ•—", ok ? "ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ä¿å­˜ã—ã¾ã—ãŸã€‚" : "ãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
    });

    $("#btnCopyOutput2").addEventListener("click", async () => {
      if(!state.output.trim()){
        toast("å‡ºåŠ›ãŒç©ºã§ã™", "å…ˆã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const ok = await copyToClipboard(state.output);
      toast(ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ" : "ã‚³ãƒ”ãƒ¼å¤±æ•—", ok ? "ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ä¿å­˜ã—ã¾ã—ãŸã€‚" : "ãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
    });

    $("#btnDownload").addEventListener("click", () => {
      if(!state.output.trim()){
        toast("å‡ºåŠ›ãŒç©ºã§ã™", "å…ˆã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const tpl = state.templates.find(t=>t.id===state.activeTemplateId);
      const safeName = (tpl?.name || "prompt").replace(/[\\/:*?"<>|]/g, "_");
      const filename = `prompt_${safeName}_${new Date().toISOString().slice(0,10)}.txt`;
      downloadText(filename, state.output, "text/plain;charset=utf-8");
      toast("ä¿å­˜ã—ã¾ã—ãŸ", filename);
    });

    $("#btnAddToHistory").addEventListener("click", addToHistory);
    $("#btnClearHistory").addEventListener("click", () => {
      const ok = confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
      if(ok) clearHistory();
    });

    $("#btnResetInputs").addEventListener("click", resetInputs);
    $("#btnQuickFill").addEventListener("click", quickFill);

    $("#btnTheme").addEventListener("click", () => {
      state.ui.theme = (state.ui.theme === "dark") ? "light" : "dark";
      applyTheme();
      saveUI();
      toast("ãƒ†ãƒ¼ãƒåˆ‡æ›¿", state.ui.theme === "dark" ? "ãƒ€ãƒ¼ã‚¯" : "ãƒ©ã‚¤ãƒˆ");
    });

    $("#btnManage").addEventListener("click", openManage);
    $("#btnCloseManage").addEventListener("click", closeManage);
    manageBackdrop.addEventListener("click", (e)=> {
      if(e.target === manageBackdrop) closeManage();
    });

    $("#btnSaveTemplate").addEventListener("click", () => {
      saveTemplateFromModal();
    });
    $("#btnNewTemplate").addEventListener("click", () => {
      newTemplate();
    });
    $("#btnDeleteTemplate").addEventListener("click", () => {
      deleteActiveTemplate();
      // If modal open, refresh form
      const tpl = state.templates.find(t=>t.id===state.activeTemplateId);
      if(tpl) fillManageForm(tpl);
    });

    $("#btnImportExport").addEventListener("click", openIE);
    $("#btnCloseIE").addEventListener("click", closeIE);
    ieBackdrop.addEventListener("click", (e)=> {
      if(e.target === ieBackdrop) closeIE();
    });

    $("#btnExport").addEventListener("click", exportTemplates);
    $("#btnCopyExport").addEventListener("click", async () => {
      const text = $("#exportArea").value.trim();
      if(!text){ toast("ç©ºã§ã™", "å…ˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚"); return; }
      const ok = await copyToClipboard(text);
      toast(ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ" : "ã‚³ãƒ”ãƒ¼å¤±æ•—");
    });
    $("#btnDownloadExport").addEventListener("click", () => {
      const text = $("#exportArea").value.trim();
      if(!text){ toast("ç©ºã§ã™", "å…ˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚"); return; }
      downloadText(`prompt_studio_templates_${new Date().toISOString().slice(0,10)}.json`, text, "application/json;charset=utf-8");
      toast("JSONã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    });

    $("#btnImport").addEventListener("click", () => importTemplates(false));
    $("#btnOverwriteImport").addEventListener("click", () => {
      const ok = confirm("ç¾åœ¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã™ã¹ã¦ç½®ãæ›ãˆã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
      if(ok) importTemplates(true);
    });
  };

  // ---------- Filters / Search ----------
  const wireFilters = () => {
    $("#searchTemplate").addEventListener("input", (e) => {
      state.ui.search = e.target.value;
      saveUI();
      renderTemplates();
    });

    $("#filterCategory").addEventListener("change", (e) => {
      state.ui.filterCategory = e.target.value;
      saveUI();
      renderTemplates();
    });

    $("#filterLang").addEventListener("change", (e) => {
      state.ui.filterLang = e.target.value;
      saveUI();
      renderTemplates();
    });
  };

  // ---------- Keyboard Shortcuts ----------
  const wireShortcuts = () => {
    document.addEventListener("keydown", async (e) => {
      const isMac = navigator.platform.toLowerCase().includes("mac");
      const cmd = isMac ? e.metaKey : e.ctrlKey;

      // Ignore shortcuts while typing in inputs except allowed combos
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      const inTyping = ["input","textarea","select"].includes(tag);

      // "/" focuses search
      if(e.key === "/" && !cmd && !e.altKey){
        if(inTyping) return;
        e.preventDefault();
        $("#searchTemplate").focus();
        return;
      }

      // Generate: Ctrl/Cmd + Enter
      if(cmd && e.key === "Enter"){
        e.preventDefault();
        generate();
        return;
      }

      // Single-key shortcuts (when not typing)
      if(inTyping) return;

      if(e.key.toLowerCase() === "t"){
        state.ui.theme = (state.ui.theme === "dark") ? "light" : "dark";
        applyTheme(); saveUI();
        toast("ãƒ†ãƒ¼ãƒåˆ‡æ›¿", state.ui.theme === "dark" ? "ãƒ€ãƒ¼ã‚¯" : "ãƒ©ã‚¤ãƒˆ");
      }
      if(e.key.toLowerCase() === "m"){
        if(manageBackdrop.classList.contains("show")) closeManage();
        else openManage();
      }
      if(e.key.toLowerCase() === "i"){
        if(ieBackdrop.classList.contains("show")) closeIE();
        else openIE();
      }
      if(e.key.toLowerCase() === "c"){
        if(!state.output.trim()) { toast("å‡ºåŠ›ãŒç©ºã§ã™"); return; }
        const ok = await copyToClipboard(state.output);
        toast(ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ" : "ã‚³ãƒ”ãƒ¼å¤±æ•—");
      }
      if(e.key.toLowerCase() === "h"){
        addToHistory();
      }
      if(e.key.toLowerCase() === "d"){
        $("#btnDownload").click();
      }
      if(e.key === "Escape"){
        if(manageBackdrop.classList.contains("show")) closeManage();
        if(ieBackdrop.classList.contains("show")) closeIE();
      }
    });
  };

  // ---------- Init ----------
  const init = () => {
    loadState();
    applyTheme();

    // Apply saved UI filters/search
    $("#searchTemplate").value = state.ui.search || "";
    $("#filterLang").value = state.ui.filterLang || "ja";
    // category options will be built inside renderTemplates
    renderTemplates();

    bindInputs();
    renderHistory();
    renderOutput();

    wireTemplateClicks();
    wireHistoryClicks();
    wireButtons();
    wireFilters();
    wireShortcuts();

    // Set filter category from saved UI after options exist
    rebuildCategoryOptions();
    if(state.ui.filterCategory){
      $("#filterCategory").value = state.ui.filterCategory;
    }

    // Set theme button label/feel
    $("#autosaveState").textContent = "autosave: on";

    // Auto-generate once on load (optional)
    generate();
  };

  // ---------- Modal prefill on open selection change ----------
  templateListEl.addEventListener("dblclick", () => {
    // Double-click opens manage modal for active template
    openManage();
  });

  // When active template changes while manage modal open, keep form in sync
  const observer = new MutationObserver(() => {
    if(manageBackdrop.classList.contains("show")){
      const tpl = state.templates.find(t=>t.id===state.activeTemplateId);
      if(tpl) fillManageForm(tpl);
    }
  });
  observer.observe(templateListEl, {childList:true, subtree:true});

  init();
})();
</script>
</body>
</html>
